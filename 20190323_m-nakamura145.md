# オンライン予約徹底解説

https://speakerdeck.com/m_nakamura145/onrainyu-yue-che-di-jie-shuo-number-railsdm2019

## 飲食店のオンライン予約は難しい

紙で予約を管理してるから「完全なオンライン予約は不可能」

複数のグルメメディアに在庫掲出してる
-> ウォークインの客が来ると、複数サイトのオンラインの在庫を閉じないといけない

完全なオンライン予約のためには予約台帳のデジタル化が不可欠 -> Toreta

## Toretaをつかった予約のオペレーション

電話
  トレタフォン/コンタクトセンター/IVR
オウンドメディア
  web予約
  予約API
グルメサイト
  Googleで予約
  Toreta Now

営業中はToretaだけを見ていればよくなった

## 予約の入れ方を工夫すると売り上げが上がる

18:00-20:00/20:00-22:00だと２回転、1900-2100だと同じ席でも１回転しかできない。
空間的制約
  席結合で人数を増やせる。席結合をシステムに落とし込まないといけない
時間的制約
  営業日/営業時間/予約の滞在時間/予約の受付期間/予約受付締め切り期間
  営業日は一つ一つ設定できる
  時間はランチ/ディナーに分けているが、曜日ごとに設定できる。祝日専用設定もある

テーブルあたりの席の効率をあげないと利益は上がらない

## 初期のweb予約在庫設計思想

空間的、時間的な概念を仮想的な枠として定義した
　18:00-20:00、個室１、というような枠を定義し、入ってくる予約をお店がコントロールしていた

繁盛店向けの高度なテーブルマネジメントを実現可能にしている

## 在庫計算は必要な時にやっている

初期は在庫参照のタイミングも少なく、永続化する必要がなかった（一般の人がお店を予約するときだけ在庫の計算が必要だった。）
FindWebReservationTables(restaurant.self, start_at, end_at, seats, option).execute
在庫計算に必要な全てのテーブルをかき集めて計算してる

## 上だけではハマらないユースケースが増えてきた

### 1.常に予約が埋まるわけではない店舗

普通のお店はそこまで高度なテーブルマネジメントをしていない

### 2.大手法人

５００店舗の設定を一気にするのは無理。設定代行をやっていたがしんどい

予約のreadが爆増した


### 予約在庫の設計思想の変更

空きは在庫として出して、見せたくないところを埋める
閉じたいところを閉じる


クエリの影響範囲小 <>大
予約/テーブル/テーブルグループ/営業日/営業時間

各リソースの作成・更新・削除のタイミングでsidekiqで再計算

## 今後

* 既存のweb予約と在庫モデルの融合 -> 頑張って統一する
* 高度な設定/簡単な設定どちらもできるようにする

## QA

### ドタキャン対策
* no showの保証サービス。５％はドタキャンがある

### 予約機能、実装する/市内の判断

台帳のPOが判断する。リアーキテクチャはボトムアップで決めて進めている

### 設計思想がスマートだが、そこに到るまでの要件定義はどやっているのか？

業務設計がしっかりしている。なぜなら飲食店を経営していたから。
実装前に緻密な分析をしていたので。
テーブル設計もとてもよくできている

