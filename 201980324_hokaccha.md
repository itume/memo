# 巨大なモノリシック Rails アプリケーションのマイクロサービス化戦略

## お台場プロジェクト

２年前くらいから。草の根活動的にはじまった。
* コード削除
* コンテナ化
* システム分離

cookpad_allというでかいリポジトリ
* cookpad(Web/REST API)
* papa(管理画面)
* kuroko(バッチ)
* mobile
webとREST APIが合体していたが、ここを分離した
ちょっとづつDocker化している

## どこで切るか？

マイクロサービス化して失敗したものある（新規アプリだからと言って分けるのがいいというわけでもない）
組織の切れ目で、って言っても、組織もわりと流動的

-> データの切れ目で分離する、というのを目安にしている

## データの切れ目？

* 30以上のDB(main dbに800テーブル)
* 10以上のRedis
* Solar,GDBMとかもある

## 事例

### 検索システム

Solarがバックエンド、複雑なドメインロジックの塊
->これについてはうまくいった
RESTでやってたが、gRPCに置き換えた
RailsでgRPCのサーバーを実装しているが、gRPCのgemの出来がよくないので自作している

内部通信にgRPCを使うのが最近のcookpadでのブーム

### 料理きろく

料理の写真だけを機械学習で判別して記録。
データがでかいのでAurolaにおいていたので、分離が簡単だった

-> エンドポイントごとに新しいRails Appに移動した。nginxで振り分け。

### モバイル

エンドポイントが多かったので、上と同じ戦略は取れず。
未実装のエンドポイントは503を返してnginxが旧アプリに振り分けた

## microfrontends

cookpadはUIコンポーネントごとにチームが分かれるようなサービスじゃないので、Controller単位とかで分けたらいいと思っている

Backend - BFF(GraphQL?) - Frontend

（RecipeControllerは1600行くらいあって、67アクションあった）

セッション,Cookie,ログとかどうするかは考え中

## microservice難しい

難しいのはわかっているが、これをやらないとサービス成長が止まると思っているのでやっている
しかしこれやってるチームには２人しかいない
